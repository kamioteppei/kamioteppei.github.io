---
layout: static
title: AWS
template: 3-columns
name: AWS
category: Environment
---

# AWS

Amazon Web Services

## 基本

以下を参照

[「AWS is 何」を3行でまとめてみる](https://qiita.com/kohashi/items/1bb952313fb695f12577)

## IAM

AWS Identity and Access Managementの略  

AWSサービスやリーソースに対するアクセスの権限管理の設定  
デフォルトのrootユーザーは通常は使用しない。  
IAMユーザーは、関係者1人につき1つ発行する。  
定期的に、各IAMユーザーの権限の見直しと、不要なIAMユーザーの削除を行う。

### IAMポリシー  
ユーザー権限の定義で、AWSサービスの内、権限を付加したいサービスのみを選択できる。
各サービスでの、参照、実行権限を、全ての機能ごとに設定できる。
  - IAMユーザー
  - IAMグループ

実際の開発プロジェクトでは、
- まず、管理者、アプリ開発者、インフラ担当者等のIAMポリシーを作成する。
- 次に、それぞれのIAMグループを作成し、上記の権限を付加する。
- 最後に、各IAMユーザーを、IAMグループに振り分ける。

### IAMロール
プログラムからAWSの操作をする場合に、権限を持ったIAMユーザーのシークレットキーを
EC2インスタンスに登録すれば可能だが、内部的には、テキストファイルに情報を保つ為、
セキュアではない。そこで、IAMポリシーと同様に、IAMロールという権限の定義を行い、
EC2インスタンスなどに、そのIAMロールを設定することで、サーバーにシークレットキーを
持つことなく、AWSをプログラムから実行できる。

## アクセスキーとシークレットアクセスキー

AWSマネージメントコンソールのみで運用する場合は、キーを発行しない。  
ローカルのコマンドラインからEC2にSSH接続する場合や、EC2のプログラム内で、  
他のAWSリーソース(RDS)にアクセスする場合等に使用する。  
ただし、プログラムにキーをハードコーディングしてはいけない。Githubにあげたらもっとだめ。  
IAMロールを上手く活用する方法での、AWSの連携がおすすめらしい。  
コマンドラインでAWSの管理操作をする場合は、AWS CLIをローカルにインストールする。  
EC2インスタンスにアクセスするだけなら、ターミナルからSSHで接続すれば良い。  
プログラムからAWSにアクセスする場合は、SDK APIを使用する。

- EC2インスタンスへのSSH接続は、EC2インスタンス作成時に、公開鍵と秘密鍵のペアを発行できるので、それを使用する。   
`ssh -i <作成したキーの名前.pem> ec2-user@<EC2インスタンスのIP>`  

- SDKで使用するアクセスキーは、IAMユーザーの認証情報タブにある、[アクセスキーの作成]ボタンから作成する。
プログラムを実行する端末のAWS CLIの登録は`aws configure`で、以下を登録。
```
AWS Access Key ID [None]: <上記のキー>
AWS Secret Access Key [None]: <上記のシークレットキー>
Default region name [None]: <リージョン>
Default output format [None]: json
```

## VPC

以下のAWSサービスを自分のアカウントのVPC内に配置する。

- EC2(汎用サーバー)
- RDS(マネージドなRDBサービス)
- Redshift(分析用データベース)
- EMR(hadoop)

VPC内では、インターネットに公開する、パブリックなサブネットと、  
非公開のプライベートなサブネットを作成する。

パブリックなサブネットで公開するサービス
- EC2   
この場合、EC2のインバウンドで、sshとhttp,https用のポートのみ許可する。  
sshの設定では、IPは管理者のグローバルIPのみを受け付ける。  
httpの設定では、IPは0.0.0.0/0(制限なし)を受け付ける。

プライベートなサブネットで公開するサービス
- RDS   
この場合、RDSのインバウンドで、RDS用のポートのみ許可する。  
EC2のサブネットからの接続のみを受け付ける。  
または、Webサーバ(EC2インスタンス)に設定されている、
セキュリティーグループを指定する。

下記のサービスは、VPC外のAWS内のパブリックなサービスとなる。  
- S3(Simple Strage Service)
- Lambda
- DynamoDB
- CloudWatch

## インターネットゲートウェイとNATゲートウェイ

- インターネットゲートウェイ  
インターネットとVPC内のパブリックなEC2インスタンスを中継するルート
  - パブリックなEC2インスタンスにElasticIPを割り振ると、IPが固定されるが、EC2を起動しない時間に料金が発生する。

- NATゲートウェイ  
インターネットとVPC内のプライベートなEC2インスタンスを、一時的に中継できるようにする為のルート。   
NATゲートウェイを使用する目的は、プライベートなEC2インスタンスでも、一時的にモジュールの取得、更新などで、インターネットに接続する必要がある為。  
  - パブリックなサブネットワークにNATゲートウェイを作成する。この時、ElasticIPを割り振っているので、NATゲートウェイの削除時に、ElasticIPも削除する。削除しないと料金がかかる。
  - プライベートのサブネットのルートテーブルに、設定を追加し、外部との通信は、NATゲートウェイを使用するようにする。
  - インターネットに接続する作業が終了したら、NATゲートウェイを削除する。ルートテーブルを戻す。ElasticIPも解放する。

## セキュリティーグループとネットワークACL

- セキュリティグループ  
EC２インスタンスのファイアーウォール設定

- ネットワークACL  
サブネットワークのファイアーウォール設定  
インバウンドとアウトバウンドの設定を分けて設定できる。(ステートレス)

## EC2

Amazon Elastic Compute Cloudの略

ミドルウェアをインストールして、下記の用途に使用する。

- Webサーバー
- アプリサーバー
- DBサーバー
- バッチサーバー

## RDBとRDS

- RDB
  - 自分で、EC2にmysqlなどのミドルウェアをインストールする。
  - バックアップ等の作業を自分で行う必要がある。
  - mysqlの接続は`mysql -h <mysqlのEC2のprivte IP> -u root -p`
  - プログラムでアクセスする場合も同じ。マスター->スレーブのIPの切り替えは環境変数を変えないといけない。

- RDS
  - サブネットグループを作成し、そこにmysql等のDBインスタンスを作成する。
  - サブネットグループに複数のAZのサブネットを指定するで、マルチAZという設定ができる。
  - マルチAZの設定をONにするだけで、マスター->スレイブ構成を組むことができる。
  - 上記の場合、片方のAZのサーバーがマスターとなり、そのサーバーが異常状態になると、自動的に、もう一つのAZのスレーブが、
  マスターに昇格する。
  - mysqlの接続は`mysql -h <mysqlのインスタンスのrds_endpoint> -u root -p`
  - プログラムでアクセスする場合も同じ。DNSがIPを切り替えてくれる。
  - mysqlのパラメータは、作成したパラメータグループの各設定を変更する。
  - マルチAZの設定をする場合は、サブネットグループを作成する必要がある。   
  ElastiCacheなどの異なるAWSサービスとはサブネットグループを共有できない。

- DBツール

[参照](https://www.infoscoop.org/blogjp/2014/08/18/connect-to-rds-via-mysql-workbench/)   
MySQL公式サイトからWorkbenchというGUIのDB操作ツールをダウンロードできる。(要Oracleユーザーアカウント)  
AWSの自分のVPC内で、WebサーバーのEC2インスタンスから、RDSのMySQLに接続する環境の場合において、
ローカルのWorkbenchに、EC2のIPとPemファイルの場所、RDSのエンドポイントを設定するだけで、
MySQLに簡単に接続できる。

## ロードバランシングとオートスケーリング

ロードバランシングとオートスケーリングを組み合わせると、可用性が高まり、１つのAZが災害にあっても、サービスを継続することができる。

- ロードバランシング   
ロードバランサーにはALB(アプリケーションロードバランサー)とNLB(ネットワークロードバランサー)がある。
ALBを選択した場合は、ロードバランサーのターゲットグループを作成し、そこに登録された、複数のAZのEC2インスタンスにアクセスを振り分けられる。

- オートスケーリング   
上記のターゲットグループには、EC2インスタンスを、既存のEC2インスタンスから選んで静的に登録しても良いし、オートスケーリングの場合では、EC2インスタンスのAMIを元に、動的にターゲットグループに登録することができる。  
オートスケーリングで注意することは、スケールアウト、スケールイン(EC2インスタンスが生成、削除される)に対応すること、また、ロードバランシングで、どのサーバーに振り分けられても良いように考慮し、アプリやログなどを、ステートレスに設計することである。セッションファイルをキャッシュにする、EC2インスタンスが削除される前にログファイルをS3に移すようにする。

## CloudFrontとElastiCache

- CloudFront  
Webコンテンツのキャッシュサービス(Content Delivery Network(CDN)サービス)  
世界中に100を超えるエッジロケーションがあり、キャッシュしている。   
CloudFrontインスタンス作成時に、ELBを指定できる。Route53(DNS)とELB(ロードバランサー)の
中間に位置し、ロードバランサー経由で、定期的に、最新のコンテンツをキャッシュする。

- ElastiCache  
DBレスポンスのキャッシュ  
以下のNoSQL(key-value)を使用する。
  - Redis
  - Memcached  
メモリに情報を持つので、レスポンスが速い

### Redis
remote dictionary server

- 接続は`redis-cli -h <redisのエンドポイント>`
- key-valueのセットは`set <key> <value>`
- key-valueのゲットは`get <key>`
その他、リスト操作もできる。また、pub/sub(publish/subscribe)機能もある。

## SES
Simple Email Service

## SQS
Simple Queue Service

## SNS
Simple Notification Service

## CloudWatch
CPU、メモリ、料金等の使用状況を監視し、設定した閾値を超えた場合のアクションを行う。

## CloudTrail
AWSの操作ログをS3に格納する。   
大量の操作ログをS3に格納していて、料金がかかりそうなので、作成したCloudTrailの設定を削除した。

## サーバーレスアーキテクチャー

VPCとその中のWebサーバーや、DBを使用せずに、  
AWSのAPI Gateway、Lambda、S3、DynamoDB等で構成するサービス

- AWS SAM  
Serverless Application Modelの略
サーバーレス構成に特化した、Cloudformation(CFn)のテンプレート  
つまり、サーバーレスの構成には、CFnではなく、SAMを使用した方が良いということ。

- Serverless Framework(非AWS)  
Serverless Framework.comが提供するサービス。
npmでServerless Frameworkをインストールする。AWSのIAMを使用し、コマンドラインで操作する。

### Serverless構成例

- AWS S3  
node.js + npm + angular cli等の開発環境でビルドした、  
html,css,jsファイルをホスティングする。  
ログ用のバケットも作成する。設定画面で、ログ用のバケットを指定できる。

- AWS Cognito  
ユーザープール作成、認証サービス。
jsでcognitoのライブラリを使用する。

- AWS API Gateway  
リソースと、リソースに対するメソッドを作成する。  
リソース名を{}で囲むと、動的に指定できる。
swaggerのymlファイルから、API構成をインポートできる。

- AWS Lambda  
Lambdaには300秒の実行時間制限があるので、日次処理のようなデータを一度にたくさん処理する使い方には本来向いていない。

- AWS DynamoDB  
NoSQL

## AWS WAF
Web Application Firewall
CloudFrontの前に設置すると思われる。

## AWS構成作図

[参照](https://aws.amazon.com/jp/architecture/icons/)  
上記で、AWSのアイコンを使用し、作図できる。
