<!DOCTYPE html>
<html lang="ja">
<head prefix:og="http://ogp.me/ns#">
  <meta charset="UTF-8">
  <title>AWS | kamioteppei.github.io</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700">
  <!-- Default CSS -->
  <link rel="stylesheet" href="/assets/css/style.css">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="AWS">
  <link rel="canonical" href="http://0.0.0.0:4000/memos/aws">
  <link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="kamioteppei.github.io" />
  
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      displayAlign: "left",
      displayIndent: "2em"
    });
  </script>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script language="JavaScript">
    $(document).ready( function () {
       $("a[href^='http']:not([href*='" + location.hostname + "'])").attr('target', '_blank');
    })
  </script>
</head>
<body>

<header class="header">
  <nav id="nav" class="nav">
    <div class="container nav__container">
      <div class="nav__brand"><a class="nav__title" href="/">kamioteppei.github.io</a></div>
      <div id="nav__btn" class="nav__btn"><i class="fa fa-bars"></i></div>
      <ul id="nav__list" class="nav__list">
        
          <li class="nav__item"><a href="/">Home</a></li>
        
        
          
            <li class="nav__item"><a href="/stack/">Stack</a></li>
          
        
          
            <li class="nav__item"><a href="/blog/">Blog</a></li>
          
        
          
            <li class="nav__item"><a href="/links/">Links</a></li>
          
        
          
            <li class="nav__item"><a href="/portfolio/">Portfolio</a></li>
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
  </nav>
</header>











<div class="contents page">

  
    <div class="container">

      <!--
      <div class="page__header">
  <h1 class="page__title">AWS</h1>
  
  
    <p class="page__date">September 28, 2019</p>
  
</div>

    -->

      <div class="page__body">
        <div class="row">

          <div class="col-2 sidebar order-xs-first">
            <nav id="jqxTree" class="jqxTree">
  <!--
  https://www.siteleaf.com/blog/advanced-liquid-group-by/
  -->
  
  <ul>
    
      <li class="">
        Native
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/android">Android</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/ios">iOS</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/react-native">React Native</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/vr">VR/AR</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Front-end
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/angularjs">Angular</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/react">React</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/typescript">Typescript</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/vue">Vue</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Environment
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/aws">AWS</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/ci">CI/CD</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/docker">Docker</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/elasticsearch">Elasticsearch</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/gcp">GCP</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/git">Git</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/heroku">Heroku</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/mac">Mac</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/package-management">Package Manager</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/ssh">SSH</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/ubuntu">Ubuntu</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/vagrant">Vagrant</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        UI/UX
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/bootstrap">Bootstrap</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Engineer
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/career">Career</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/freelance">Freelance</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Machine Learning
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/competition">Competition</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/data">Data</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/jupyter-notebook">Jupyter Notebook</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/machine-learning">Machine Learning</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/math">Math</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/nlp">Natural Language Processing</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/opencv">OpenCV</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/python">Python</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Tools
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/excel">Excel</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/js-fiddle">JS Fiddle</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/sql-fiddle">SQL Fiddle</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/tablacus">Tablacus</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        Web
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/http">HTTP</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/jekyll">Jekyll</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/laravel">Laravel</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/markdown">Markdown</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/rails">Rails</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/security">Security</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/spring">Spring</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/swagger">Swagger</a></div>
          </li>
        
        </ul>
    </li>
    
      <li class="">
        DataBase
        <ul>
        
          <li class="">
            <div class=""><a href="/memos/mysql">MySQL</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/oracle">Oracle</a></div>
          </li>
        
          <li class="">
            <div class=""><a href="/memos/postgresql">PostgreSQL</a></div>
          </li>
        
        </ul>
    </li>
    
  </ul>
</nav>

          </div>

          <div class="col-8 main toc-src order-first">
            <h1 id="aws">AWS</h1>

<p>Amazon Web Services</p>

<h2 id="基本">基本</h2>

<p>以下を参照</p>

<p><a href="https://qiita.com/kohashi/items/1bb952313fb695f12577">「AWS is 何」を3行でまとめてみる</a></p>

<h2 id="iam">IAM</h2>

<p>AWS Identity and Access Managementの略</p>

<p>AWSサービスやリーソースに対するアクセスの権限管理の設定<br />
デフォルトのrootユーザーは通常は使用しない。<br />
IAMユーザーは、関係者1人につき1つ発行する。<br />
定期的に、各IAMユーザーの権限の見直しと、不要なIAMユーザーの削除を行う。</p>

<h3 id="iamポリシー">IAMポリシー</h3>
<p>ユーザー権限の定義で、AWSサービスの内、権限を付加したいサービスのみを選択できる。
各サービスでの、参照、実行権限を、全ての機能ごとに設定できる。</p>
<ul>
  <li>IAMユーザー</li>
  <li>IAMグループ</li>
</ul>

<p>実際の開発プロジェクトでは、</p>
<ul>
  <li>まず、管理者、アプリ開発者、インフラ担当者等のIAMポリシーを作成する。</li>
  <li>次に、それぞれのIAMグループを作成し、上記の権限を付加する。</li>
  <li>最後に、各IAMユーザーを、IAMグループに振り分ける。</li>
</ul>

<h3 id="iamロール">IAMロール</h3>
<p>プログラムからAWSの操作をする場合に、権限を持ったIAMユーザーのシークレットキーを
EC2インスタンスに登録すれば可能だが、内部的には、テキストファイルに情報を保つ為、
セキュアではない。そこで、IAMポリシーと同様に、IAMロールという権限の定義を行い、
EC2インスタンスなどに、そのIAMロールを設定することで、サーバーにシークレットキーを
持つことなく、AWSをプログラムから実行できる。</p>

<h2 id="アクセスキーとシークレットアクセスキー">アクセスキーとシークレットアクセスキー</h2>

<p>AWSマネージメントコンソールのみで運用する場合は、キーを発行しない。<br />
ローカルのコマンドラインからEC2にSSH接続する場合や、EC2のプログラム内で、<br />
他のAWSリーソース(RDS)にアクセスする場合等に使用する。<br />
ただし、プログラムにキーをハードコーディングしてはいけない。Githubにあげたらもっとだめ。<br />
IAMロールを上手く活用する方法での、AWSの連携がおすすめらしい。<br />
コマンドラインでAWSの管理操作をする場合は、AWS CLIをローカルにインストールする。<br />
EC2インスタンスにアクセスするだけなら、ターミナルからSSHで接続すれば良い。<br />
プログラムからAWSにアクセスする場合は、SDK APIを使用する。</p>

<ul>
  <li>
    <p>EC2インスタンスへのSSH接続は、EC2インスタンス作成時に、公開鍵と秘密鍵のペアを発行できるので、それを使用する。 <br />
<code class="highlighter-rouge">ssh -i &lt;作成したキーの名前.pem&gt; ec2-user@&lt;EC2インスタンスのIP&gt;</code></p>
  </li>
  <li>
    <p>SDKで使用するアクセスキーは、IAMユーザーの認証情報タブにある、[アクセスキーの作成]ボタンから作成する。
プログラムを実行する端末のAWS CLIの登録は<code class="highlighter-rouge">aws configure</code>で、以下を登録。</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AWS Access Key ID [None]: &lt;上記のキー&gt;
AWS Secret Access Key [None]: &lt;上記のシークレットキー&gt;
Default region name [None]: &lt;リージョン&gt;
Default output format [None]: json
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="vpc">VPC</h2>

<p>以下のAWSサービスを自分のアカウントのVPC内に配置する。</p>

<ul>
  <li>EC2(汎用サーバー)</li>
  <li>RDS(マネージドなRDBサービス)</li>
  <li>Redshift(分析用データベース)</li>
  <li>EMR(hadoop)</li>
</ul>

<p>VPC内では、インターネットに公開する、パブリックなサブネットと、<br />
非公開のプライベートなサブネットを作成する。</p>

<p>パブリックなサブネットで公開するサービス</p>
<ul>
  <li>EC2 <br />
この場合、EC2のインバウンドで、sshとhttp,https用のポートのみ許可する。<br />
sshの設定では、IPは管理者のグローバルIPのみを受け付ける。<br />
httpの設定では、IPは0.0.0.0/0(制限なし)を受け付ける。</li>
</ul>

<p>プライベートなサブネットで公開するサービス</p>
<ul>
  <li>RDS <br />
この場合、RDSのインバウンドで、RDS用のポートのみ許可する。<br />
EC2のサブネットからの接続のみを受け付ける。<br />
または、Webサーバ(EC2インスタンス)に設定されている、
セキュリティーグループを指定する。</li>
</ul>

<p>下記のサービスは、VPC外のAWS内のパブリックなサービスとなる。</p>
<ul>
  <li>S3(Simple Strage Service)</li>
  <li>Lambda</li>
  <li>DynamoDB</li>
  <li>CloudWatch</li>
</ul>

<h2 id="インターネットゲートウェイとnatゲートウェイ">インターネットゲートウェイとNATゲートウェイ</h2>

<ul>
  <li>インターネットゲートウェイ<br />
インターネットとVPC内のパブリックなEC2インスタンスを中継するルート
    <ul>
      <li>パブリックなEC2インスタンスにElasticIPを割り振ると、IPが固定されるが、EC2を起動しない時間に料金が発生する。</li>
    </ul>
  </li>
  <li>NATゲートウェイ<br />
インターネットとVPC内のプライベートなEC2インスタンスを、一時的に中継できるようにする為のルート。 <br />
NATゲートウェイを使用する目的は、プライベートなEC2インスタンスでも、一時的にモジュールの取得、更新などで、インターネットに接続する必要がある為。
    <ul>
      <li>パブリックなサブネットワークにNATゲートウェイを作成する。この時、ElasticIPを割り振っているので、NATゲートウェイの削除時に、ElasticIPも削除する。削除しないと料金がかかる。</li>
      <li>プライベートのサブネットのルートテーブルに、設定を追加し、外部との通信は、NATゲートウェイを使用するようにする。</li>
      <li>インターネットに接続する作業が終了したら、NATゲートウェイを削除する。ルートテーブルを戻す。ElasticIPも解放する。</li>
    </ul>
  </li>
</ul>

<h2 id="セキュリティーグループとネットワークacl">セキュリティーグループとネットワークACL</h2>

<ul>
  <li>
    <p>セキュリティグループ<br />
EC２インスタンスのファイアーウォール設定</p>
  </li>
  <li>
    <p>ネットワークACL<br />
サブネットワークのファイアーウォール設定<br />
インバウンドとアウトバウンドの設定を分けて設定できる。(ステートレス)</p>
  </li>
</ul>

<h2 id="ec2">EC2</h2>

<p>Amazon Elastic Compute Cloudの略</p>

<p>ミドルウェアをインストールして、下記の用途に使用する。</p>

<ul>
  <li>Webサーバー</li>
  <li>アプリサーバー</li>
  <li>DBサーバー</li>
  <li>バッチサーバー</li>
</ul>

<h2 id="rdbとrds">RDBとRDS</h2>

<ul>
  <li>RDB
    <ul>
      <li>自分で、EC2にmysqlなどのミドルウェアをインストールする。</li>
      <li>バックアップ等の作業を自分で行う必要がある。</li>
      <li>mysqlの接続は<code class="highlighter-rouge">mysql -h &lt;mysqlのEC2のprivte IP&gt; -u root -p</code></li>
      <li>プログラムでアクセスする場合も同じ。マスター-&gt;スレーブのIPの切り替えは環境変数を変えないといけない。</li>
    </ul>
  </li>
  <li>RDS
    <ul>
      <li>サブネットグループを作成し、そこにmysql等のDBインスタンスを作成する。</li>
      <li>サブネットグループに複数のAZのサブネットを指定するで、マルチAZという設定ができる。</li>
      <li>マルチAZの設定をONにするだけで、マスター-&gt;スレイブ構成を組むことができる。</li>
      <li>上記の場合、片方のAZのサーバーがマスターとなり、そのサーバーが異常状態になると、自動的に、もう一つのAZのスレーブが、
マスターに昇格する。</li>
      <li>mysqlの接続は<code class="highlighter-rouge">mysql -h &lt;mysqlのインスタンスのrds_endpoint&gt; -u root -p</code></li>
      <li>プログラムでアクセスする場合も同じ。DNSがIPを切り替えてくれる。</li>
      <li>mysqlのパラメータは、作成したパラメータグループの各設定を変更する。</li>
      <li>マルチAZの設定をする場合は、サブネットグループを作成する必要がある。 <br />
ElastiCacheなどの異なるAWSサービスとはサブネットグループを共有できない。</li>
    </ul>
  </li>
  <li>DBツール</li>
</ul>

<p><a href="https://www.infoscoop.org/blogjp/2014/08/18/connect-to-rds-via-mysql-workbench/">参照</a> <br />
MySQL公式サイトからWorkbenchというGUIのDB操作ツールをダウンロードできる。(要Oracleユーザーアカウント)<br />
AWSの自分のVPC内で、WebサーバーのEC2インスタンスから、RDSのMySQLに接続する環境の場合において、
ローカルのWorkbenchに、EC2のIPとPemファイルの場所、RDSのエンドポイントを設定するだけで、
MySQLに簡単に接続できる。</p>

<h2 id="ロードバランシングとオートスケーリング">ロードバランシングとオートスケーリング</h2>

<p>ロードバランシングとオートスケーリングを組み合わせると、可用性が高まり、１つのAZが災害にあっても、サービスを継続することができる。</p>

<ul>
  <li>
    <p>ロードバランシング <br />
ロードバランサーにはALB(アプリケーションロードバランサー)とNLB(ネットワークロードバランサー)がある。
ALBを選択した場合は、ロードバランサーのターゲットグループを作成し、そこに登録された、複数のAZのEC2インスタンスにアクセスを振り分けられる。</p>
  </li>
  <li>
    <p>オートスケーリング <br />
上記のターゲットグループには、EC2インスタンスを、既存のEC2インスタンスから選んで静的に登録しても良いし、オートスケーリングの場合では、EC2インスタンスのAMIを元に、動的にターゲットグループに登録することができる。<br />
オートスケーリングで注意することは、スケールアウト、スケールイン(EC2インスタンスが生成、削除される)に対応すること、また、ロードバランシングで、どのサーバーに振り分けられても良いように考慮し、アプリやログなどを、ステートレスに設計することである。セッションファイルをキャッシュにする、EC2インスタンスが削除される前にログファイルをS3に移すようにする。</p>
  </li>
</ul>

<h2 id="cloudfrontとelasticache">CloudFrontとElastiCache</h2>

<ul>
  <li>
    <p>CloudFront<br />
Webコンテンツのキャッシュサービス(Content Delivery Network(CDN)サービス)<br />
世界中に100を超えるエッジロケーションがあり、キャッシュしている。 <br />
CloudFrontインスタンス作成時に、ELBを指定できる。Route53(DNS)とELB(ロードバランサー)の
中間に位置し、ロードバランサー経由で、定期的に、最新のコンテンツをキャッシュする。</p>
  </li>
  <li>
    <p>ElastiCache<br />
DBレスポンスのキャッシュ<br />
以下のNoSQL(key-value)を使用する。</p>
    <ul>
      <li>Redis</li>
      <li>Memcached<br />
メモリに情報を持つので、レスポンスが速い</li>
    </ul>
  </li>
</ul>

<h3 id="redis">Redis</h3>
<p>remote dictionary server</p>

<ul>
  <li>接続は<code class="highlighter-rouge">redis-cli -h &lt;redisのエンドポイント&gt;</code></li>
  <li>key-valueのセットは<code class="highlighter-rouge">set &lt;key&gt; &lt;value&gt;</code></li>
  <li>key-valueのゲットは<code class="highlighter-rouge">get &lt;key&gt;</code>
その他、リスト操作もできる。また、pub/sub(publish/subscribe)機能もある。</li>
</ul>

<h2 id="ses">SES</h2>
<p>Simple Email Service</p>

<h2 id="sqs">SQS</h2>
<p>Simple Queue Service</p>

<h2 id="sns">SNS</h2>
<p>Simple Notification Service</p>

<h2 id="cloudwatch">CloudWatch</h2>
<p>CPU、メモリ、料金等の使用状況を監視し、設定した閾値を超えた場合のアクションを行う。</p>

<h2 id="cloudtrail">CloudTrail</h2>
<p>AWSの操作ログをS3に格納する。 <br />
大量の操作ログをS3に格納していて、料金がかかりそうなので、作成したCloudTrailの設定を削除した。</p>

<h2 id="サーバーレスアーキテクチャー">サーバーレスアーキテクチャー</h2>

<p>VPCとその中のWebサーバーや、DBを使用せずに、<br />
AWSのAPI Gateway、Lambda、S3、DynamoDB等で構成するサービス</p>

<ul>
  <li>
    <p>AWS SAM<br />
Serverless Application Modelの略
サーバーレス構成に特化した、Cloudformation(CFn)のテンプレート<br />
つまり、サーバーレスの構成には、CFnではなく、SAMを使用した方が良いということ。</p>
  </li>
  <li>
    <p>Serverless Framework(非AWS)<br />
Serverless Framework.comが提供するサービス。
npmでServerless Frameworkをインストールする。AWSのIAMを使用し、コマンドラインで操作する。</p>
  </li>
</ul>

<h3 id="serverless構成例">Serverless構成例</h3>

<ul>
  <li>
    <p>AWS S3<br />
node.js + npm + angular cli等の開発環境でビルドした、<br />
html,css,jsファイルをホスティングする。<br />
ログ用のバケットも作成する。設定画面で、ログ用のバケットを指定できる。</p>
  </li>
  <li>
    <p>AWS Cognito<br />
ユーザープール作成、認証サービス。
jsでcognitoのライブラリを使用する。</p>
  </li>
  <li>
    <p>AWS API Gateway<br />
リソースと、リソースに対するメソッドを作成する。<br />
リソース名を{}で囲むと、動的に指定できる。
swaggerのymlファイルから、API構成をインポートできる。</p>
  </li>
  <li>
    <p>AWS Lambda<br />
Lambdaには300秒の実行時間制限があるので、日次処理のようなデータを一度にたくさん処理する使い方には本来向いていない。</p>
  </li>
  <li>
    <p>AWS DynamoDB<br />
NoSQL</p>
  </li>
</ul>

<h2 id="aws-waf">AWS WAF</h2>
<p>Web Application Firewall
CloudFrontの前に設置すると思われる。</p>

<h2 id="aws構成作図">AWS構成作図</h2>

<p><a href="https://aws.amazon.com/jp/architecture/icons/">参照</a><br />
上記で、AWSのアイコンを使用し、作図できる。</p>


          </div>

          <div class="col-2 sidebar order-xs-first">
            <nav class="toc"></nav>

          </div>

        </div><!--row-->
      </div><!--page-body-->

    </div><!--container-->

  

</div><!--page-->



<footer class="footer">
  
  <div class="container container--sm footer__container">
  
    <p class="copyright"><small>&copy; 2018 kamioteppei</small></p>

    <div class="social-link">
      
        <p class="social-link__item">
          <a href="https://github.com/kamioteppei"><i class="fa fa-github"></i></a>
        </p>
      
      
    </div>
  </div><!--container-->
</footer>

<script src="/assets/js/jfgp.js"></script>
</body>
</html>
